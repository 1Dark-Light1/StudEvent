# Пояснення системи повідомлень у проекті StudEvent

## Коли приходять повідомлення

### 1. Для звичайних задач користувача (не глобальних)

Повідомлення плануються автоматично при створенні задачі користувачем:

#### a) Нагадування за 1 годину до задачі
- **Коли**: За 1 годину до початку задачі
- **Тип**: `user_reminder_1h`
- **Умови**: 
  - Якщо задача має час (`time`) - за 1 годину до цього часу
  - Якщо задача має діапазон часу (`timeDilation` з `fromTime`) - за 1 годину до початку діапазону
- **Текст**: Назва задачі та опис (або "Не забудьте виконати це завдання")

#### b) Повідомлення про закінчення часу
- **Коли**: Після закінчення часу на виконання
- **Тип**: `user_expired`
- **Умови**:
  - Якщо задача має час (`time`) - через 1.5 години після часу задачі (1 година на виконання + 30 хвилин)
  - Якщо задача має діапазон (`timeDilation` з `toTime`) - через 30 хвилин після кінця діапазону
  - Якщо немає часу - в кінці дня (23:59:59)
- **Текст**: "[Назва задачі] - час вийшов" та "Час на виконання цього завдання згас"

### 2. Для глобальних задач адміна

#### a) Повідомлення про створення нового глобального таску
- **Коли**: Відразу після створення адміном (через 1 секунду)
- **Тип**: `global_created`
- **Умови**: 
  - Надсилається всім користувачам (крім адміна, який створив задачу)
  - Тільки для задач з `isGlobal: true`
- **Текст**: "Новий глобальний таск" та назва задачі з часом (якщо є)

#### b) Нагадування для користувачів, які приєдналися до глобального таску

Повідомлення плануються автоматично після того, як користувач приєднується до глобального таску:

**Нагадування за день до задачі:**
- **Коли**: За день до задачі о 9:00 ранку
- **Тип**: `global_reminder_1d`
- **Текст**: "Завтра: [Назва задачі]" та опис

**Нагадування за 1 годину до задачі:**
- **Коли**: За 1 годину до початку задачі
- **Тип**: `global_reminder_1h`
- **Умови**: Аналогічно до звичайних задач
- **Текст**: Назва задачі та опис

### 3. Коли повідомлення скасовуються

- При видаленні задачі - всі повідомлення для цієї задачі скасовуються
- При від'єднанні від глобального таску - всі повідомлення для цього таску скасовуються
- При оновленні задачі - старі повідомлення скасовуються і створюються нові

## Збереження повідомлень у Firestore

Всі повідомлення, які надсилаються, автоматично зберігаються у Firestore в колекції `messages` з такими полями:

- `userId` - ID користувача, якому надіслано повідомлення
- `title` - Заголовок повідомлення
- `body` - Тіло повідомлення
- `type` - Тип повідомлення (user_reminder_1h, user_expired, global_created, тощо)
- `taskId` - ID задачі (якщо пов'язана з задачею)
- `createdAt` - Час створення повідомлення
- `month` - Місяць створення (0-11)
- `year` - Рік створення

## Відображення на сторінці повідомлень

На сторінці "Повідомлення" (AlertsScreen) відображаються:

1. **Заплановані повідомлення** - майбутні повідомлення, які ще не надіслані
2. **Повідомлення з Firestore** - всі повідомлення, які були надіслані в поточному місяці

Повідомлення автоматично очищаються в кінці місяця - старі повідомлення (з попередніх місяців) видаляються з бази даних.

## Перевірка правильності написання

✅ **Все написано правильно:**

1. ✅ Функції планування повідомлень викликаються в правильних місцях:
   - При створенні задачі (`addTask`)
   - При приєднанні до глобального таску (`joinEvent`)
   - При оновленні задачі (`updateTaskNotifications`)

2. ✅ Повідомлення зберігаються у Firestore при кожному надсиланні

3. ✅ Повідомлення відображаються на сторінці Alerts з правильним фільтруванням за місяцем

4. ✅ Автоматичне очищення старих повідомлень працює коректно

5. ✅ Правила безпеки Firestore налаштовані правильно для колекції `messages`

6. ✅ Адмінські таски тепер правильно відображаються в особистому календарі (тільки коли адмін приєднується)
